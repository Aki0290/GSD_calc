<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GSD Calc Pro</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GSD Calc">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; 
            background: #f2f2f7; 
            margin: 0; 
            padding: env(safe-area-inset-top) 15px 20px 15px; 
            color: #1c1c1e; 
            -webkit-tap-highlight-color: transparent; 
        }
        .container { max-width: 100%; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h2 { text-align: center; margin: 0 0 15px 0; font-size: 1.2rem; color: #1c1c1e; }
        
        .mode-switch { display: flex; background: #e5e5ea; border-radius: 10px; padding: 4px; margin-bottom: 20px; }
        .mode-option { flex: 1; text-align: center; padding: 10px; font-size: 0.9rem; font-weight: bold; cursor: pointer; border-radius: 8px; color: #8e8e93; transition: 0.3s; }
        .mode-option.active { background: white; color: #007aff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem; color: #8e8e93; }
        input, select { 
            width: 100%; padding: 12px; margin-bottom: 15px; 
            border: 1px solid #d1d1d6; border-radius: 10px; 
            box-sizing: border-box; font-size: 16px; 
            background: #f2f2f7; appearance: none;
        }
        select { font-weight: 500; color: #333; }
        
        input:disabled { background: #e5e5ea; color: #888; border-color: #eee; cursor: not-allowed; }
        input:focus, select:focus { border-color: #007aff; background: #fff; outline: none; }
        
        /* ã‚¹ãƒ©ã‚¤ãƒ€ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            margin: 10px 0;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 28px;
            width: 28px;
            border-radius: 50%;
            background: #ffffff;
            border: 1px solid #d1d1d6;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            margin-top: -12px;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #007aff;
            border-radius: 2px;
        }

        .opt-section { background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 15px; }
        .opt-title { font-size: 0.9rem; font-weight: bold; color: #555; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }

        details { margin-top: 30px; border-top: 5px solid #f2f2f7; padding-top: 20px; }
        summary { font-weight: bold; color: #007aff; cursor: pointer; margin-bottom: 15px; list-style: none; text-align: center; }
        
        button { 
            width: 100%; padding: 16px; background: #007aff; color: white; 
            border: none; border-radius: 12px; font-size: 18px; font-weight: bold; 
            cursor: pointer; margin-top: 5px;
        }
        button:active { background: #005ecb; transform: scale(0.98); }

        .btn-delete { background: #ff3b30; margin-top: 5px; font-size: 14px; padding: 10px; display: none; }
        .btn-save { background: #34c759; margin-top: 10px; }

        .result-box { margin-top: 25px; background: #e5f1ff; padding: 15px; border-radius: 12px; border: 2px solid #007aff; }
        .result-main { text-align: center; margin-bottom: 10px; }
        .result-main .val { display: block; font-size: 2rem; font-weight: 800; color: #007aff; }
        .result-main .label { font-size: 0.9rem; color: #004085; }
        .result-sub { font-size: 0.85rem; color: #555; text-align: center; border-top: 1px solid rgba(0,122,255,0.2); padding-top: 10px; }
        
        .blur-res { margin-top: 10px; padding: 10px; border-radius: 8px; font-size: 0.85rem; font-weight: bold; text-align: center; display: none; }
        .blur-ok { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .blur-ng { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* ã‚ºãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        .zoom-container { display: none; background: #fffbe6; padding: 15px; border-radius: 10px; border: 1px solid #ffe58f; margin-bottom: 15px; }
        .zoom-block { margin-bottom: 15px; border-bottom: 1px dashed #eaddb6; padding-bottom: 10px; }
        .zoom-block:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }
        
        .zoom-header { font-weight: bold; font-size: 0.9rem; color: #b7950b; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .zoom-val-disp { font-size: 1.1rem; color: #333; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>GSDè¨ˆç®—æ©Ÿ</h2>

    <div class="mode-switch">
        <div class="mode-option active" id="modeNormal" onclick="setMode('normal')">GSDç®—å‡º<br><small>(è·é›¢ â†’ GSD)</small></div>
        <div class="mode-option" id="modeReverse" onclick="setMode('reverse')">è·é›¢ç®—å‡º<br><small>(GSD â†’ è·é›¢)</small></div>
    </div>

    <label>æ©Ÿç¨®ãƒ»ãƒ¬ãƒ³ã‚ºã‚’é¸æŠ</label>
    <select id="droneSelect" onchange="updateDrone()">
        <option value="manual">-- æ‰‹å‹•å…¥åŠ› (Manual) --</option>
        <optgroup label="ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿæ" id="userGroup" style="display:none;"></optgroup>

        <optgroup label="ã‚ºãƒ¼ãƒ å¯¾å¿œæ©Ÿç¨® (Optical Range)">
            <option value="h20_zoom">Zenmuse H20 (Zoom Mode)</option>
            <option value="m30_zoom">Matrice 30/30T (Zoom Mode)</option>
        </optgroup>

        <optgroup label="DJI Zenmuse Payloads">
            <option value="p1_24mm">Zenmuse P1 (24mm)</option>
            <option value="p1_35mm">Zenmuse P1 (35mm)</option>
            <option value="l2_rgb">Zenmuse L2 RGB (24mm eq)</option>
            <option value="h20_wide">Zenmuse H20 (Wide Only)</option>
        </optgroup>

        <optgroup label="DJI Matrice 4 Series">
            <option value="m4t_wide">Matrice 4T Wide (24mm eq)</option>
            <option value="m4t_med">Matrice 4T Med (70mm eq)</option>
            <option value="m4t_tele">Matrice 4T Tele (168mm eq)</option>
            <option value="m4d_wide">Matrice 4D Wide (24mm eq)</option>
        </optgroup>

        <optgroup label="DJI Matrice 30 Series">
            <option value="m30_wide">Matrice 30/30T Wide (24mm eq)</option>
        </optgroup>

        <optgroup label="Phase One">
            <option value="ixm100_80mm">iXM 100MP (80mm)</option>
        </optgroup>

        <optgroup label="DJI Mavic 3 Series">
            <option value="m3_classic">Mavic 3 Classic (24mm eq)</option>
            <option value="m3_pro">Mavic 3 / 3 Pro (24mm eq)</option>
            <option value="m3e_wide">Mavic 3 Enterprise (24mm eq)</option>
        </optgroup>

        <optgroup label="DJI Mavic 2 Series">
            <option value="m2_pro">Mavic 2 Pro (28mm eq)</option>
            <option value="m2_zoom">Mavic 2 Zoom (24mm eq)</option>
            <option value="m2_ent">Mavic 2 Enterprise (24mm eq)</option>
        </optgroup>
    </select>
    
    <button id="btnDelete" class="btn-delete" onclick="deleteCustomDrone()">ã“ã®ã‚«ã‚¹ã‚¿ãƒ æ©Ÿæã‚’å‰Šé™¤</button>

    <div id="zoomArea" class="zoom-container">
        <div class="zoom-block">
            <div class="zoom-header">
                <span>å€ç‡ (Magnification)</span>
                <span id="magDisplay" class="zoom-val-disp">1.0x</span>
            </div>
            <input type="range" id="magSlider" step="any" oninput="syncZoom('magSlider')">
            <div style="display:flex; align-items:center; gap:10px;">
                <input type="number" id="magInput" step="0.1" inputmode="decimal" oninput="syncZoom('magInput')" onchange="finalizeZoom()">
                <span>å€ (x)</span>
            </div>
        </div>

        <div class="zoom-block">
            <div class="zoom-header">
                <span>ç„¦ç‚¹è·é›¢ (Focal Length)</span>
                <span id="focalDisplay" class="zoom-val-disp">24.0mm</span>
            </div>
            <input type="range" id="focalSlider" step="any" oninput="syncZoom('focalSlider')">
            <div style="display:flex; align-items:center; gap:10px;">
                <input type="number" id="focalInput" step="1" inputmode="decimal" oninput="syncZoom('focalInput')" onchange="finalizeZoom()">
                <span>mm (35mmåˆ¤)</span>
            </div>
        </div>
    </div>

    <div style="display:flex; gap:10px;">
        <div style="flex:1;">
            <label id="lblDist">è·é›¢ (m)</label>
            <input type="number" id="distance" value="30" step="1" inputmode="decimal">
        </div>
        <div style="flex:1;">
            <label id="lblGsd">ç›®æ¨™GSD (mm/px)</label>
            <input type="number" id="target_gsd" value="5.0" step="0.1" inputmode="decimal" disabled>
        </div>
    </div>
    
    <label>æ°´å¹³ç”»è§’ H-FOV (Â°)</label>
    <input type="number" id="hfov" value="73.7" step="0.1" inputmode="decimal">

    <div class="opt-section">
        <div class="opt-title">ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ãƒ–ãƒ©ãƒ¼</div>
        <div style="display:flex; gap:10px;">
            <div style="flex:1;">
                <label>é£›è¡Œé€Ÿåº¦ (m/s)</label>
                <input type="number" id="speed" placeholder="ä¾‹: 5" inputmode="decimal">
            </div>
            <div style="flex:1;">
                <label>ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ 1 / X</label>
                <input type="number" id="shutter" placeholder="ä¾‹: 1000" inputmode="numeric">
            </div>
        </div>
    </div>

    <div style="display:none;">
        <input type="number" id="sensor_w" value="35.9">
        <input type="number" id="sensor_h" value="24.0">
        <input type="number" id="pixel_w" value="8192">
        <input type="number" id="base_focal" value="24"> </div>

    <button onclick="calculate()">è¨ˆç®—å®Ÿè¡Œ</button>

    <div class="result-box" id="resultArea" style="display:none;">
        <div class="result-main">
            <span class="label" id="resLabel">GSD</span>
            <span class="val" id="resMain">--</span>
        </div>
        <div class="result-sub" id="resSub">æ’®å½±ç¯„å›²: --</div>
        <div id="blurResult" class="blur-res"></div>
    </div>

    <details>
        <summary>æ–°ã—ã„æ©Ÿæãƒ»ãƒ¬ãƒ³ã‚ºã‚’ç™»éŒ²ã™ã‚‹</summary>
        <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-top: 10px;">
            <label>ç™»éŒ²å (ä¾‹: My Drone 24mm)</label>
            <input type="text" id="new_name" placeholder="åç§°ã‚’å…¥åŠ›">
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>æ°´å¹³ç”»è§’ H-FOV (Â°)</label>
                    <input type="number" id="new_fov" placeholder="84">
                </div>
                <div style="flex:1;">
                    <label>æ¨ªç”»ç´ æ•° (px)</label>
                    <input type="number" id="new_pw" placeholder="5280">
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>ã‚»ãƒ³ã‚µãƒ¼æ¨ª (mm)</label>
                    <input type="number" id="new_sw" placeholder="17.3">
                </div>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label>ã‚»ãƒ³ã‚µãƒ¼ç¸¦ (mm)</label>
                        <input type="number" id="new_sh" placeholder="13.0">
                    </div>
                </div>
            </div>
            <button class="btn-save" onclick="saveCustomDrone()">ã“ã®è¨­å®šã‚’ä¿å­˜</button>
        </div>
    </details>
</div>

<script>
    // ==========================================
    // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
    // å‰²ã‚Šç®—ã‚’ãã®ã¾ã¾è¨˜è¿°ã—ã¦å³å¯†ãªå€¤ã‚’ä¿æŒã—ã¾ã™
    // ==========================================
    const defaultData = {
        // --- ã‚ºãƒ¼ãƒ æ©Ÿ ---
        "h20_zoom": { 
            name: "Zenmuse H20 (Zoom Mode)", 
            sw: 6.17, sh: 4.55, pw: 4056, fov: 73,
            baseFocal: 24, 
            // å®Ÿã‚¹ãƒšãƒƒã‚¯: 31.7mm ï½ 556.2mm
            minZoom: 31.7 / 24, 
            maxZoom: 556.2 / 24 
        },
        "m30_zoom": { 
            name: "Matrice 30/30T (Zoom Mode)", 
            sw: 6.4, sh: 4.8, pw: 8000, fov: 73, 
            baseFocal: 24,
            // å®Ÿã‚¹ãƒšãƒƒã‚¯: 113mm ï½ 405mm
            minZoom: 113 / 24,  
            maxZoom: 405 / 24   
        },

        // --- å›ºå®šãƒ¬ãƒ³ã‚º ---
        "m4t_wide": { name: "Matrice 4T Wide (24mm)", sw: 9.6, sh: 7.2, pw: 8064, fov: 73 },
        "m4t_med":  { name: "Matrice 4T Med (70mm)",  sw: 9.6, sh: 7.2, pw: 8064, fov: 35 }, 
        "m4t_tele": { name: "Matrice 4T Tele (168mm)", sw: 8.8, sh: 6.6, pw: 8064, fov: 15 },
        "m4d_wide": { name: "Matrice 4D Wide (24mm)", sw: 17.3, sh: 13.0, pw: 5280, fov: 73.7 },
        "m30_wide": { name: "Matrice 30/30T Wide (24mm)", sw: 6.4, sh: 4.8, pw: 4000, fov: 73 },
        "p1_24mm": { name: "Zenmuse P1 (24mm)", sw: 35.9, sh: 24.0, pw: 8192, fov: 73.7 },
        "p1_35mm": { name: "Zenmuse P1 (35mm)", sw: 35.9, sh: 24.0, pw: 8192, fov: 54.4 },
        "h20_wide": { name: "Zenmuse H20 (Wide Only)", sw: 6.17, sh: 4.55, pw: 4056, fov: 73 }, 
        "l2_rgb":   { name: "Zenmuse L2 RGB (24mm)", sw: 17.3, sh: 13.0, pw: 5280, fov: 73.7 },
        "ixm100_80mm": { name: "iXM 100MP (80mm)", sw: 44.0, sh: 33.0, pw: 11664, fov: 30.7 },
        "m3_classic": { name: "Mavic 3 Classic (24mm)", sw: 17.3, sh: 13.0, pw: 5280, fov: 73.7 },
        "m3_pro":     { name: "Mavic 3 / 3 Pro (24mm)", sw: 17.3, sh: 13.0, pw: 5280, fov: 73.7 },
        "m3e_wide":   { name: "Mavic 3 Enterprise (24mm)",sw: 17.3, sh: 13.0, pw: 5280, fov: 73.7 },
        "m2_pro":  { name: "Mavic 2 Pro (28mm)",  sw: 13.2, sh: 8.8, pw: 5472, fov: 65 }, 
        "m2_zoom": { name: "Mavic 2 Zoom (24mm)", sw: 6.17, sh: 4.55, pw: 4000, fov: 73 },
        "m2_ent":  { name: "Mavic 2 Enterprise (24mm)",  sw: 6.17, sh: 4.55, pw: 4000, fov: 73 }
    };

    let allDroneData = {};
    let currentMode = 'normal';

    window.onload = function() { 
        loadDrones();
        updateDrone(); 
    };

    function loadDrones() {
        allDroneData = { ...defaultData };
        const stored = localStorage.getItem('myCustomDrones');
        const userGroup = document.getElementById('userGroup');
        userGroup.innerHTML = ""; 

        if (stored) {
            const customDrones = JSON.parse(stored);
            if (Object.keys(customDrones).length > 0) {
                userGroup.style.display = "block";
                for (const [key, data] of Object.entries(customDrones)) {
                    allDroneData[key] = data;
                    let option = document.createElement("option");
                    option.value = key;
                    option.text = data.name;
                    userGroup.appendChild(option);
                }
            } else {
                userGroup.style.display = "none";
            }
        }
    }

    function saveCustomDrone() {
        const name = document.getElementById('new_name').value;
        const fov = parseFloat(document.getElementById('new_fov').value);
        const pw = parseFloat(document.getElementById('new_pw').value);
        const sw = parseFloat(document.getElementById('new_sw').value);
        const sh = parseFloat(document.getElementById('new_sh').value);

        if (!name || !fov || !pw || !sw || !sh) {
            alert("ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }

        let customDrones = {};
        const stored = localStorage.getItem('myCustomDrones');
        if (stored) customDrones = JSON.parse(stored);

        const id = "custom_" + Date.now();
        customDrones[id] = { name: name, sw: sw, sh: sh, pw: pw, fov: fov };

        localStorage.setItem('myCustomDrones', JSON.stringify(customDrones));
        alert(`ã€Œ${name}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`);
        loadDrones(); 
        document.getElementById('droneSelect').value = id;
        updateDrone();
        document.getElementById('new_name').value = "";
    }

    function deleteCustomDrone() {
        const key = document.getElementById('droneSelect').value;
        if (!key.startsWith("custom_")) return;
        if (confirm("ã“ã®ã‚«ã‚¹ã‚¿ãƒ æ©Ÿæã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            let customDrones = JSON.parse(localStorage.getItem('myCustomDrones'));
            delete customDrones[key];
            localStorage.setItem('myCustomDrones', JSON.stringify(customDrones));
            alert("å‰Šé™¤ã—ã¾ã—ãŸ");
            loadDrones();
            document.getElementById('droneSelect').value = "manual";
            updateDrone();
        }
    }

    function setMode(mode) {
        currentMode = mode;
        const distInput = document.getElementById('distance');
        const gsdInput = document.getElementById('target_gsd');
        const btnNormal = document.getElementById('modeNormal');
        const btnReverse = document.getElementById('modeReverse');

        if (mode === 'normal') {
            btnNormal.classList.add('active');
            btnReverse.classList.remove('active');
            if (currentMode === 'normal') distInput.disabled = false;
            gsdInput.disabled = true;
            distInput.style.backgroundColor = "#fff";
            gsdInput.style.backgroundColor = "#e5e5ea";
        } else {
            btnNormal.classList.remove('active');
            btnReverse.classList.add('active');
            distInput.disabled = true;
            gsdInput.disabled = false;
            distInput.style.backgroundColor = "#e5e5ea";
            gsdInput.style.backgroundColor = "#fff";
        }
        document.getElementById('resultArea').style.display = 'none';
        
        updateDrone();
    }

    // ==========================================
    // ğŸ”„ ãƒ€ãƒ–ãƒ«ã‚¹ãƒ©ã‚¤ãƒ€é€£å‹• & å³å¯†è¨ˆç®—
    // ==========================================
    function syncZoom(source) {
        const magSlider = document.getElementById('magSlider');
        const magInput = document.getElementById('magInput');
        const magDisplay = document.getElementById('magDisplay');

        const focalSlider = document.getElementById('focalSlider');
        const focalInput = document.getElementById('focalInput');
        const focalDisplay = document.getElementById('focalDisplay');

        const baseFocal = parseFloat(document.getElementById('base_focal').value) || 24;
        const minMag = parseFloat(magSlider.min);
        const maxMag = parseFloat(magSlider.max);

        // --- ç¾åœ¨ã®å€ç‡ã‚’è¨ˆç®—ï¼ˆãƒ•ãƒ«ç²¾åº¦ï¼‰ ---
        let currentMag = minMag; 

        if (source.includes('mag')) {
            // å€ç‡å´ã‚’æ“ä½œ
            let val = parseFloat(source === 'magSlider' ? magSlider.value : magInput.value);
            if (!isNaN(val)) currentMag = val;
        } else {
            // ç„¦ç‚¹è·é›¢å´ã‚’æ“ä½œ
            let val = parseFloat(source === 'focalSlider' ? focalSlider.value : focalInput.value);
            if (!isNaN(val)) currentMag = val / baseFocal;
        }

        // ç¯„å›²åˆ¶é™ï¼ˆå³å¯†å€¤ã§ã‚¯ãƒ©ãƒ³ãƒ—ï¼‰
        let clampedMag = currentMag;
        if (clampedMag < minMag) clampedMag = minMag;
        if (clampedMag > maxMag) clampedMag = maxMag;

        // --- UIæ›´æ–° ---
        
        // 1. Slider (å³å¯†ãªå€¤ã‚’ã‚»ãƒƒãƒˆã€step="any"ãªã®ã§ç«¯ã¾ã§å±Šã)
        magSlider.value = clampedMag;
        focalSlider.value = clampedMag * baseFocal;

        // 2. Display (è¡¨ç¤ºã¯å°æ•°ç¬¬ä¸€ä½ã§ä¸¸ã‚ã‚‹)
        magDisplay.innerText = clampedMag.toFixed(1) + "x";
        focalDisplay.innerText = (clampedMag * baseFocal).toFixed(1) + "mm";

        // 3. Input Box (å…¥åŠ›ä¸­ã¯ä¸Šæ›¸ãã›ãšã€ä»–ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«çµŒç”±ã®æ™‚ã®ã¿æ›´æ–°)
        if (source !== 'magInput') {
            magInput.value = clampedMag.toFixed(1);
        }
        if (source !== 'focalInput') {
            focalInput.value = (clampedMag * baseFocal).toFixed(1);
        }

        calculate();
    }

    function finalizeZoom() {
        syncZoom('magSlider'); 
    }

    function updateDrone() {
        const key = document.getElementById('droneSelect').value;
        const deleteBtn = document.getElementById('btnDelete');
        const zoomArea = document.getElementById('zoomArea');
        
        const magSlider = document.getElementById('magSlider');
        const magInput = document.getElementById('magInput');
        const magDisplay = document.getElementById('magDisplay');

        const focalSlider = document.getElementById('focalSlider');
        const focalInput = document.getElementById('focalInput');
        const focalDisplay = document.getElementById('focalDisplay');
        
        const isManual = (key === 'manual');
        const fovInput = document.getElementById('hfov');

        fovInput.disabled = !isManual;
        fovInput.style.backgroundColor = !isManual ? "#e5e5ea" : "#fff";

        if (key.startsWith("custom_")) {
            deleteBtn.style.display = "block";
        } else {
            deleteBtn.style.display = "none";
        }

        if (isManual) {
            zoomArea.style.display = "none";
            return;
        }

        const d = allDroneData[key];

        if (d.maxZoom) {
            zoomArea.style.display = "block";
            document.getElementById('base_focal').value = d.baseFocal || 24;
            const base = d.baseFocal || 24;
            
            // ã‚¹ãƒ©ã‚¤ãƒ€è¨­å®š (å³å¯†å€¤)
            magSlider.min = d.minZoom;
            magSlider.max = d.maxZoom;
            focalSlider.min = d.minZoom * base;
            focalSlider.max = d.maxZoom * base;

            // åˆæœŸåŒ–ï¼ˆæœ€å°ã‚ºãƒ¼ãƒ ï¼‰
            const startMag = d.minZoom;
            magSlider.value = startMag;
            focalSlider.value = startMag * base;
            
            // è¡¨ç¤ºç”¨
            magInput.value = startMag.toFixed(1);
            magDisplay.innerText = startMag.toFixed(1) + "x";
            focalInput.value = (startMag * base).toFixed(1);
            focalDisplay.innerText = (startMag * base).toFixed(1) + "mm";

        } else {
            zoomArea.style.display = "none";
            magInput.value = 1;
        }

        document.getElementById('hfov').value = d.fov;
        document.getElementById('sensor_w').value = d.sw;
        document.getElementById('sensor_h').value = d.sh;
        document.getElementById('pixel_w').value = d.pw;
        calculate();
    }

    function calculate() {
        const fov = parseFloat(document.getElementById('hfov').value);
        const sw = parseFloat(document.getElementById('sensor_w').value);
        const sh = parseFloat(document.getElementById('sensor_h').value);
        const pw = parseFloat(document.getElementById('pixel_w').value);
        const rad = fov * (Math.PI / 180);

        const zoomArea = document.getElementById('zoomArea');
        let zoomFactor = 1.0;
        
        if (zoomArea.style.display !== 'none') {
            // è¨ˆç®—ã«ã¯å³å¯†ãªã‚¹ãƒ©ã‚¤ãƒ€ã®å€¤ã‚’ä½¿ç”¨ã™ã‚‹
            zoomFactor = parseFloat(document.getElementById('magSlider').value) || 1.0;
        }

        let resultVal = 0; 
        let gsdVal = 0;    
        let viewW = 0;
        let resultLabelText = "";
        let resultUnit = "";

        if (currentMode === 'normal') {
            const dist = parseFloat(document.getElementById('distance').value);
            if (dist > 0 && fov > 0) {
                const baseViewW = 2 * dist * Math.tan(rad / 2);
                viewW = baseViewW / zoomFactor;
                gsdVal = (viewW * 1000) / pw;
                
                resultVal = gsdVal;
                resultLabelText = "GSD";
                resultUnit = " mm/px";
                document.getElementById('resMain').innerText = resultVal.toFixed(2) + resultUnit;
            }
        } else {
            const targetGsd = parseFloat(document.getElementById('target_gsd').value);
            if (targetGsd > 0 && fov > 0) {
                viewW = (targetGsd * pw) / 1000;
                resultVal = (viewW * zoomFactor) / (2 * Math.tan(rad / 2));
                
                gsdVal = targetGsd; 
                resultLabelText = "å¿…è¦ãªæ’®å½±è·é›¢";
                resultUnit = " m";
                document.getElementById('resMain').innerText = resultVal.toFixed(1) + resultUnit;
            }
        }

        if(viewW > 0){
             const viewH = viewW * (sh / sw);
             document.getElementById('resLabel').innerText = resultLabelText;
             document.getElementById('resSub').innerText = `æ’®å½±ç¯„å›²: ${viewW.toFixed(2)} m x ${viewH.toFixed(2)} m`;
             document.getElementById('resultArea').style.display = 'block';

             const speed = parseFloat(document.getElementById('speed').value);
             const shutterDenom = parseFloat(document.getElementById('shutter').value);
             const blurBox = document.getElementById('blurResult');

             if (speed > 0 && shutterDenom > 0) {
                 const shutterSec = 1 / shutterDenom;
                 const moveMm = speed * shutterSec * 1000;
                 let msg = `ç§»å‹•ãƒ–ãƒ¬: ${moveMm.toFixed(2)} mm`;
                 
                 if (moveMm > gsdVal) {
                     blurBox.className = "blur-res blur-ng";
                     blurBox.innerText = "âš ï¸ " + msg + "\n(ãƒ–ãƒ¬ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™)";
                 } else {
                     blurBox.className = "blur-res blur-ok";
                     blurBox.innerText = "âœ… " + msg + "\n(è¨±å®¹ç¯„å›²å†…ã§ã™)";
                 }
                 blurBox.style.display = 'block';
             } else {
                 blurBox.style.display = 'none';
             }
        }
    }
</script>
</body>
</html>