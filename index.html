<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GSD Calc</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GSD Calc">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; 
            background: #f2f2f7; 
            margin: 0; 
            padding: env(safe-area-inset-top) 15px 20px 15px; 
            color: #1c1c1e; 
            -webkit-tap-highlight-color: transparent; 
        }
        .container { max-width: 100%; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h2 { text-align: center; margin: 0 0 15px 0; font-size: 1.2rem; color: #1c1c1e; }
        
        .mode-switch { display: flex; background: #e5e5ea; border-radius: 10px; padding: 4px; margin-bottom: 20px; }
        .mode-option { flex: 1; text-align: center; padding: 10px; font-size: 0.9rem; font-weight: bold; cursor: pointer; border-radius: 8px; color: #8e8e93; transition: 0.3s; }
        .mode-option.active { background: white; color: #007aff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem; color: #8e8e93; }
        input, select { 
            width: 100%; padding: 12px; margin-bottom: 15px; 
            border: 1px solid #d1d1d6; border-radius: 10px; 
            box-sizing: border-box; font-size: 16px; 
            background: #f2f2f7; appearance: none;
        }
        select { font-weight: 500; color: #333; }
        
        /* ロックされた入力欄のデザイン */
        input:disabled { background: #e5e5ea; color: #888; border-color: #eee; cursor: not-allowed; }
        input:focus, select:focus { border-color: #007aff; background: #fff; outline: none; }
        
        .opt-section { background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 15px; }
        .opt-title { font-size: 0.9rem; font-weight: bold; color: #555; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }

        details { margin-top: 30px; border-top: 5px solid #f2f2f7; padding-top: 20px; }
        summary { font-weight: bold; color: #007aff; cursor: pointer; margin-bottom: 15px; list-style: none; text-align: center; }
        
        button { 
            width: 100%; padding: 16px; background: #007aff; color: white; 
            border: none; border-radius: 12px; font-size: 18px; font-weight: bold; 
            cursor: pointer; margin-top: 5px;
        }
        button:active { background: #005ecb; transform: scale(0.98); }

        .btn-delete { background: #ff3b30; margin-top: 5px; font-size: 14px; padding: 10px; display: none; }
        .btn-save { background: #34c759; margin-top: 10px; }

        .result-box { margin-top: 25px; background: #e5f1ff; padding: 15px; border-radius: 12px; border: 2px solid #007aff; }
        .result-main { text-align: center; margin-bottom: 10px; }
        .result-main .val { display: block; font-size: 2rem; font-weight: 800; color: #007aff; }
        .result-main .label { font-size: 0.9rem; color: #004085; }
        .result-sub { font-size: 0.85rem; color: #555; text-align: center; border-top: 1px solid rgba(0,122,255,0.2); padding-top: 10px; }
        
        .blur-res { margin-top: 10px; padding: 10px; border-radius: 8px; font-size: 0.85rem; font-weight: bold; text-align: center; display: none; }
        .blur-ok { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .blur-ng { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>

<div class="container">
    <h2>GSD計算機</h2>

    <div class="mode-switch">
        <div class="mode-option active" id="modeNormal" onclick="setMode('normal')">GSDを出す<br><small>(距離 → GSD)</small></div>
        <div class="mode-option" id="modeReverse" onclick="setMode('reverse')">距離を出す<br><small>(GSD → 距離)</small></div>
    </div>

    <label>機種・レンズを選択</label>
    <select id="droneSelect" onchange="updateDrone()">
        <option value="manual">-- 手動入力 (Manual) --</option>
        <optgroup label="ユーザー登録機材" id="userGroup" style="display:none;"></optgroup>

        <optgroup label="DJI Zenmuse Payloads">
            <option value="p1_24mm">Zenmuse P1 (24mm)</option>
            <option value="p1_35mm">Zenmuse P1 (35mm)</option>
            <option value="l2_rgb">Zenmuse L2 RGB (24mm eq)</option>
            <option value="h20_wide">Zenmuse H20 Wide (24mm eq)</option>
        </optgroup>

        <optgroup label="Phase One">
            <option value="ixm100_80mm">iXM 100MP (80mm)</option>
        </optgroup>

        <optgroup label="DJI Matrice 4 Series">
            <option value="m4t_wide">Matrice 4T Wide (24mm eq)</option>
            <option value="m4t_med">Matrice 4T Med (70mm eq)</option>
            <option value="m4t_tele">Matrice 4T Tele (168mm eq)</option>
            <option value="m4d_wide">Matrice 4D Wide (24mm eq)</option>
        </optgroup>

        <optgroup label="DJI Matrice 30 Series">
            <option value="m30_wide">Matrice 30/30T Wide (24mm eq)</option>
            <option value="m30_zoom">Matrice 30/30T Zoom (～113mm)</option>
        </optgroup>

        <optgroup label="DJI Mavic 3 Series">
            <option value="m3_classic">Mavic 3 Classic (24mm eq)</option>
            <option value="m3_pro">Mavic 3 / 3 Pro (24mm eq)</option>
            <option value="m3e_wide">Mavic 3 Enterprise (24mm eq)</option>
        </optgroup>

        <optgroup label="DJI Mavic 2 Series">
            <option value="m2_pro">Mavic 2 Pro (28mm eq)</option>
            <option value="m2_zoom">Mavic 2 Zoom (24mm eq)</option>
            <option value="m2_ent">Mavic 2 Enterprise (24mm eq)</option>
        </optgroup>
    </select>
    
    <button id="btnDelete" class="btn-delete" onclick="deleteCustomDrone()">このカスタム機材を削除</button>

    <div style="display:flex; gap:10px;">
        <div style="flex:1;">
            <label id="lblDist">距離 (m)</label>
            <input type="number" id="distance" value="30" step="1" inputmode="decimal">
        </div>
        <div style="flex:1;">
            <label id="lblGsd">目標GSD (mm)</label>
            <input type="number" id="target_gsd" value="5.0" step="0.1" inputmode="decimal" disabled>
        </div>
    </div>
    
    <label>水平画角 H-FOV (°) <small style="font-weight:normal;">※プリセット時ロック</small></label>
    <input type="number" id="hfov" value="73.7" step="0.1" inputmode="decimal">

    <div class="opt-section">
        <div class="opt-title">モーションブラー</div>
        <div style="display:flex; gap:10px;">
            <div style="flex:1;">
                <label>飛行速度 (m/s)</label>
                <input type="number" id="speed" placeholder="例: 5" inputmode="decimal">
            </div>
            <div style="flex:1;">
                <label>シャッター 1 / X</label>
                <input type="number" id="shutter" placeholder="例: 1000" inputmode="numeric">
            </div>
        </div>
    </div>

    <div style="display:none;">
        <input type="number" id="sensor_w" value="35.9">
        <input type="number" id="sensor_h" value="24.0">
        <input type="number" id="pixel_w" value="8192">
    </div>

    <button onclick="calculate()">計算実行</button>

    <div class="result-box" id="resultArea" style="display:none;">
        <div class="result-main">
            <span class="label" id="resLabel">GSD</span>
            <span class="val" id="resMain">--</span>
        </div>
        <div class="result-sub" id="resSub">撮影範囲: --</div>
        <div id="blurResult" class="blur-res"></div>
    </div>

    <details>
        <summary>新しい機材・レンズを登録する</summary>
        <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-top: 10px;">
            <label>登録名 (例: My Drone 24mm)</label>
            <input type="text" id="new_name" placeholder="名称を入力">
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>水平画角 H-FOV (°)</label>
                    <input type="number" id="new_fov" placeholder="84">
                </div>
                <div style="flex:1;">
                    <label>横画素数 (px)</label>
                    <input type="number" id="new_pw" placeholder="5280">
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>センサー横 (mm)</label>
                    <input type="number" id="new_sw" placeholder="17.3">
                </div>
                <div style="flex:1;">
                    <label>センサー縦 (mm)</label>
                    <input type="number" id="new_sh" placeholder="13.0">
                </div>
            </div>
            <button class="btn-save" onclick="saveCustomDrone()">この設定を保存</button>
        </div>
    </details>
</div>

<script>
    // ==========================================
    // データセット (名称にミリ数を追記)
    // ==========================================
    const defaultData = {
        "p1_24mm": { name: "Zenmuse P1 (24mm)", sw: 35.9, sh: 24.0, pw: 8192, fov: 73.7 },
        "p1_35mm": { name: "Zenmuse P1 (35mm)", sw: 35.9, sh: 24.0, pw: 8192, fov: 54.4 },
        
        "h20_wide": { name: "Zenmuse H20 Wide (24mm eq)", sw: 6.17, sh: 4.55, pw: 4056, fov: 73 }, 
        "l2_rgb":   { name: "Zenmuse L2 RGB (24mm eq)", sw: 17.3, sh: 13.0, pw: 5280, fov: 73.7 },

        "ixm100_80mm": { name: "iXM 100MP (80mm)", sw: 44.0, sh: 33.0, pw: 11664, fov: 30.7 },

        "m4t_wide": { name: "Matrice 4T Wide (24mm eq)", sw: 9.6, sh: 7.2, pw: 8064, fov: 73 },
        "m4t_med":  { name: "Matrice 4T Med (70mm eq)",  sw: 9.6, sh: 7.2, pw: 8064, fov: 35 },
        "m4t_tele": { name: "Matrice 4T Tele (168mm eq)", sw: 8.8, sh: 6.6, pw: 8064, fov: 15 },
        "m4d_wide": { name: "Matrice 4D Wide (24mm eq)", sw: 17.3, sh: 13.0, pw: 5280, fov: 73.7 },

        "m30_wide": { name: "Matrice 30/30T Wide (24mm eq)", sw: 6.4, sh: 4.8, pw: 4000, fov: 73 },
        "m30_zoom": { name: "Matrice 30/30T Zoom (～113mm)", sw: 6.4, sh: 4.8, pw: 8000, fov: 35 }, 

        "m3_classic": { name: "Mavic 3 Classic (24mm eq)", sw: 17.3, sh: 13.0, pw: 5280, fov: 73.7 },
        "m3_pro":     { name: "Mavic 3 / 3 Pro (24mm eq)", sw: 17.3, sh: 13.0, pw: 5280, fov: 73.7 },
        "m3e_wide":   { name: "Mavic 3 Enterprise (24mm eq)",sw: 17.3, sh: 13.0, pw: 5280, fov: 73.7 },

        "m2_pro":  { name: "Mavic 2 Pro (28mm eq)",  sw: 13.2, sh: 8.8, pw: 5472, fov: 65 }, 
        "m2_zoom": { name: "Mavic 2 Zoom (24mm eq)", sw: 6.17, sh: 4.55, pw: 4000, fov: 73 },
        "m2_ent":  { name: "Mavic 2 Enterprise (24mm eq)",  sw: 6.17, sh: 4.55, pw: 4000, fov: 73 }
    };

    let allDroneData = {};
    let currentMode = 'normal';

    window.onload = function() { 
        loadDrones();
        updateDrone(); 
    };

    function loadDrones() {
        allDroneData = { ...defaultData };
        const stored = localStorage.getItem('myCustomDrones');
        const userGroup = document.getElementById('userGroup');
        userGroup.innerHTML = ""; 

        if (stored) {
            const customDrones = JSON.parse(stored);
            if (Object.keys(customDrones).length > 0) {
                userGroup.style.display = "block";
                for (const [key, data] of Object.entries(customDrones)) {
                    allDroneData[key] = data;
                    let option = document.createElement("option");
                    option.value = key;
                    option.text = data.name;
                    userGroup.appendChild(option);
                }
            } else {
                userGroup.style.display = "none";
            }
        }
    }

    function saveCustomDrone() {
        const name = document.getElementById('new_name').value;
        const fov = parseFloat(document.getElementById('new_fov').value);
        const pw = parseFloat(document.getElementById('new_pw').value);
        const sw = parseFloat(document.getElementById('new_sw').value);
        const sh = parseFloat(document.getElementById('new_sh').value);

        if (!name || !fov || !pw || !sw || !sh) {
            alert("すべての項目を入力してください");
            return;
        }

        let customDrones = {};
        const stored = localStorage.getItem('myCustomDrones');
        if (stored) customDrones = JSON.parse(stored);

        const id = "custom_" + Date.now();
        customDrones[id] = { name: name, sw: sw, sh: sh, pw: pw, fov: fov };

        localStorage.setItem('myCustomDrones', JSON.stringify(customDrones));
        alert(`「${name}」を保存しました！`);
        loadDrones(); 
        document.getElementById('droneSelect').value = id;
        updateDrone();
        document.getElementById('new_name').value = "";
    }

    function deleteCustomDrone() {
        const key = document.getElementById('droneSelect').value;
        if (!key.startsWith("custom_")) return;
        if (confirm("このカスタム機材を削除しますか？")) {
            let customDrones = JSON.parse(localStorage.getItem('myCustomDrones'));
            delete customDrones[key];
            localStorage.setItem('myCustomDrones', JSON.stringify(customDrones));
            alert("削除しました");
            loadDrones();
            document.getElementById('droneSelect').value = "manual";
            updateDrone();
        }
    }

    function setMode(mode) {
        currentMode = mode;
        const distInput = document.getElementById('distance');
        const gsdInput = document.getElementById('target_gsd');
        const btnNormal = document.getElementById('modeNormal');
        const btnReverse = document.getElementById('modeReverse');

        if (mode === 'normal') {
            btnNormal.classList.add('active');
            btnReverse.classList.remove('active');
            if (currentMode === 'normal') distInput.disabled = false;
            gsdInput.disabled = true;
            distInput.style.backgroundColor = "#fff";
            gsdInput.style.backgroundColor = "#e5e5ea";
        } else {
            btnNormal.classList.remove('active');
            btnReverse.classList.add('active');
            distInput.disabled = true;
            gsdInput.disabled = false;
            distInput.style.backgroundColor = "#e5e5ea";
            gsdInput.style.backgroundColor = "#fff";
        }
        document.getElementById('resultArea').style.display = 'none';
        
        // モード切替時にロック状態も再評価
        updateDrone();
    }

    function updateDrone() {
        const key = document.getElementById('droneSelect').value;
        const deleteBtn = document.getElementById('btnDelete');
        
        // --- 入力ロック機能 ---
        const isManual = (key === 'manual');
        const fovInput = document.getElementById('hfov');
        const distInput = document.getElementById('distance');

        // FOV等は、Manual以外では常にロック（編集不可）
        fovInput.disabled = !isManual;

        // 距離入力は、プリセットモードに関係なく、「距離を出すモード」の時はロックされる
        // （setMode関数で制御しているのでここでは触らないが、背景色の整合性をとる）
        if (!isManual) {
            fovInput.style.backgroundColor = "#e5e5ea"; // グレーアウト
        } else {
            fovInput.style.backgroundColor = "#fff";
        }

        // --- カスタム削除ボタン制御 ---
        if (key.startsWith("custom_")) {
            deleteBtn.style.display = "block";
        } else {
            deleteBtn.style.display = "none";
        }

        if (isManual) return; // マニュアルなら値の上書きはしない

        const d = allDroneData[key];
        document.getElementById('hfov').value = d.fov;
        document.getElementById('sensor_w').value = d.sw;
        document.getElementById('sensor_h').value = d.sh;
        document.getElementById('pixel_w').value = d.pw;
        calculate();
    }

    function calculate() {
        const fov = parseFloat(document.getElementById('hfov').value);
        const sw = parseFloat(document.getElementById('sensor_w').value);
        const sh = parseFloat(document.getElementById('sensor_h').value);
        const pw = parseFloat(document.getElementById('pixel_w').value);
        const rad = fov * (Math.PI / 180);

        let resultVal = 0; 
        let gsdVal = 0;    
        let viewW = 0;
        let resultLabelText = "";
        let resultUnit = "";

        if (currentMode === 'normal') {
            const dist = parseFloat(document.getElementById('distance').value);
            if (dist > 0 && fov > 0) {
                viewW = 2 * dist * Math.tan(rad / 2);
                gsdVal = (viewW * 1000) / pw;
                resultVal = gsdVal;
                resultLabelText = "GSD";
                resultUnit = " mm/px";
                document.getElementById('resMain').innerText = resultVal.toFixed(2) + resultUnit;
            }
        } else {
            const targetGsd = parseFloat(document.getElementById('target_gsd').value);
            if (targetGsd > 0 && fov > 0) {
                resultVal = (targetGsd * pw) / (2000 * Math.tan(rad / 2));
                viewW = 2 * resultVal * Math.tan(rad / 2);
                gsdVal = targetGsd; 
                resultLabelText = "必要な撮影距離";
                resultUnit = " m";
                document.getElementById('resMain').innerText = resultVal.toFixed(1) + resultUnit;
            }
        }

        if(viewW > 0){
             const viewH = viewW * (sh / sw);
             document.getElementById('resLabel').innerText = resultLabelText;
             document.getElementById('resSub').innerText = `撮影範囲: ${viewW.toFixed(2)} m x ${viewH.toFixed(2)} m`;
             document.getElementById('resultArea').style.display = 'block';

             const speed = parseFloat(document.getElementById('speed').value);
             const shutterDenom = parseFloat(document.getElementById('shutter').value);
             const blurBox = document.getElementById('blurResult');

             if (speed > 0 && shutterDenom > 0) {
                 const shutterSec = 1 / shutterDenom;
                 const moveMm = speed * shutterSec * 1000;
                 let msg = `移動ブレ: ${moveMm.toFixed(2)} mm`;
                 
                 if (moveMm > gsdVal) {
                     blurBox.className = "blur-res blur-ng";
                     blurBox.innerText = "⚠️ " + msg + "\n(ブレが画質を超えています)";
                 } else {
                     blurBox.className = "blur-res blur-ok";
                     blurBox.innerText = "✅ " + msg + "\n(許容範囲内です)";
                 }
                 blurBox.style.display = 'block';
             } else {
                 blurBox.style.display = 'none';
             }
        }
    }
</script>
</body>
</html>