<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GSD & ブラー計算機</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; background: #f2f2f7; margin: 0; padding: 15px; color: #1c1c1e; }
        .container { max-width: 100%; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h2 { text-align: center; margin: 0 0 15px 0; font-size: 1.2rem; color: #1c1c1e; }
        
        /* モード切替 */
        .mode-switch { display: flex; background: #e5e5ea; border-radius: 10px; padding: 4px; margin-bottom: 20px; }
        .mode-option { flex: 1; text-align: center; padding: 10px; font-size: 0.9rem; font-weight: bold; cursor: pointer; border-radius: 8px; color: #8e8e93; transition: 0.3s; }
        .mode-option.active { background: white; color: #007aff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem; color: #8e8e93; }
        input, select { 
            width: 100%; padding: 12px; margin-bottom: 15px; 
            border: 1px solid #d1d1d6; border-radius: 10px; 
            box-sizing: border-box; font-size: 16px; 
            background: #f2f2f7; appearance: none;
        }
        input:disabled { background: #e5e5ea; color: #aaa; border-color: #e5e5ea; }
        input:focus, select:focus { border-color: #007aff; background: #fff; outline: none; }
        
        /* オプションエリア（ブラー） */
        .opt-section { background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 15px; }
        .opt-title { font-size: 0.9rem; font-weight: bold; color: #555; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }

        button { 
            width: 100%; padding: 16px; background: #007aff; color: white; 
            border: none; border-radius: 12px; font-size: 18px; font-weight: bold; 
            cursor: pointer; margin-top: 5px;
        }
        button:active { background: #005ecb; transform: scale(0.98); }

        /* 結果表示 */
        .result-box { margin-top: 25px; background: #e5f1ff; padding: 15px; border-radius: 12px; border: 2px solid #007aff; }
        .result-main { text-align: center; margin-bottom: 10px; }
        .result-main .val { display: block; font-size: 2rem; font-weight: 800; color: #007aff; }
        .result-main .label { font-size: 0.9rem; color: #004085; }
        .result-sub { font-size: 0.85rem; color: #555; text-align: center; border-top: 1px solid rgba(0,122,255,0.2); padding-top: 10px; }
        
        /* ブラー結果（警告用） */
        .blur-res { margin-top: 10px; padding: 10px; border-radius: 8px; font-size: 0.85rem; font-weight: bold; text-align: center; display: none; }
        .blur-ok { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .blur-ng { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

    </style>
</head>
<body>

<div class="container">
    <h2>GSD計算機</h2>

    <div class="mode-switch">
        <div class="mode-option active" id="modeNormal" onclick="setMode('normal')">GSDを出す<br><small>(距離 → GSD)</small></div>
        <div class="mode-option" id="modeReverse" onclick="setMode('reverse')">距離を出す<br><small>(GSD → 距離)</small></div>
    </div>

    <label>機種を選択</label>
    <select id="droneSelect" onchange="updateDrone()">
        <option value="manual">-- 手動入力 --</option>
        <optgroup label="Matrice 4 Series">
            <option value="m4t_wide">Matrice 4T (Wide)</option>
            <option value="m4t_med">Matrice 4T (Med 70mm)</option>
            <option value="m4t_tele">Matrice 4T (Tele 168mm)</option>
        </optgroup>
        <optgroup label="Matrice 400 (H30)">
            <option value="m400_h30_wide">M400 + H30 (Wide)</option>
            <option value="m400_h30_zoom">M400 + H30 (Zoom)</option>
        </optgroup>
        <optgroup label="Phase One">
            <option value="p1_35mm">P1 (35mm)</option>
            <option value="p1_24mm">P1 (24mm)</option>
        </optgroup>
    </select>

    <div style="display:flex; gap:10px;">
        <div style="flex:1;">
            <label id="lblDist">距離 (m)</label>
            <input type="number" id="distance" value="30" step="1" inputmode="decimal">
        </div>
        <div style="flex:1;">
            <label id="lblGsd">目標GSD (mm)</label>
            <input type="number" id="target_gsd" value="5.0" step="0.1" inputmode="decimal" disabled>
        </div>
    </div>
    
    <label>水平画角 H-FOV (°)</label>
    <input type="number" id="hfov" value="84" step="0.1" inputmode="decimal">

    <div class="opt-section">
        <div class="opt-title">モーションブラー</div>
        <div style="display:flex; gap:10px;">
            <div style="flex:1;">
                <label>飛行速度 (m/s)</label>
                <input type="number" id="speed" placeholder="例: 5" inputmode="decimal">
            </div>
            <div style="flex:1;">
                <label>シャッター 1 / X</label>
                <input type="number" id="shutter" placeholder="例: 1000" inputmode="numeric">
            </div>
        </div>
    </div>

    <div style="display:none;">
        <input type="number" id="sensor_w" value="17.3">
        <input type="number" id="sensor_h" value="13.0">
        <input type="number" id="pixel_w" value="5280">
    </div>

    <button onclick="calculate()">計算実行</button>

    <div class="result-box" id="resultArea" style="display:none;">
        <div class="result-main">
            <span class="label" id="resLabel">GSD (地上画素寸法)</span>
            <span class="val" id="resMain">--</span>
        </div>
        <div class="result-sub" id="resSub">
            撮影範囲: --
        </div>
        
        <div id="blurResult" class="blur-res"></div>
    </div>
</div>

<script>
    const droneData = {
        "m4t_wide": { sw: 9.6, sh: 7.2, pw: 8064, fov: 82.1 },
        "m4t_med": { sw: 9.6, sh: 7.2, pw: 8064, fov: 35 },
        "m4t_tele": { sw: 8.8, sh: 6.6, pw: 8064, fov: 15 },
        "m400_h30_wide": { sw: 9.6, sh: 7.2, pw: 8064, fov: 82.1 },
        "m400_h30_zoom": { sw: 7.2, sh: 5.4, pw: 7328, fov: 66.7 },
        "m400_h30_thermal": { sw: 9.6, sh: 7.2, pw: 1280, fov: 45.2 },
        "m30t_wide": { sw: 6.4, sh: 4.8, pw: 4000, fov: 84 },
        "m300_h20t_wide": { sw: 6.17, sh: 4.55, pw: 4056, fov: 82.9 },
        "p1_35mm": { sw: 35.9, sh: 24.0, pw: 8192, fov: 54.4 },
        "p1_24mm": { sw: 35.9, sh: 24.0, pw: 8192, fov: 73.7 }
    };

    let currentMode = 'normal';

    window.onload = function() { updateDrone(); };

    function setMode(mode) {
        currentMode = mode;
        const distInput = document.getElementById('distance');
        const gsdInput = document.getElementById('target_gsd');
        const btnNormal = document.getElementById('modeNormal');
        const btnReverse = document.getElementById('modeReverse');

        if (mode === 'normal') {
            btnNormal.classList.add('active');
            btnReverse.classList.remove('active');
            distInput.disabled = false;
            gsdInput.disabled = true;
            distInput.style.backgroundColor = "#fff";
            gsdInput.style.backgroundColor = "#e5e5ea";
        } else {
            btnNormal.classList.remove('active');
            btnReverse.classList.add('active');
            distInput.disabled = true;
            gsdInput.disabled = false;
            distInput.style.backgroundColor = "#e5e5ea";
            gsdInput.style.backgroundColor = "#fff";
        }
        document.getElementById('resultArea').style.display = 'none';
    }

    function updateDrone() {
        const key = document.getElementById('droneSelect').value;
        if (key === "manual") return;
        const d = droneData[key];
        document.getElementById('hfov').value = d.fov;
        document.getElementById('sensor_w').value = d.sw;
        document.getElementById('sensor_h').value = d.sh;
        document.getElementById('pixel_w').value = d.pw;
        calculate();
    }

    function calculate() {
        const fov = parseFloat(document.getElementById('hfov').value);
        const sw = parseFloat(document.getElementById('sensor_w').value);
        const sh = parseFloat(document.getElementById('sensor_h').value);
        const pw = parseFloat(document.getElementById('pixel_w').value);
        const rad = fov * (Math.PI / 180);

        let resultVal = 0; // GSD or Distance
        let gsdVal = 0;    // Always calc GSD for blur comparison
        let viewW = 0;
        let resultUnit = "";
        let resultLabelText = "";

        // --- 1. メイン計算 (GSD & 距離) ---
        if (currentMode === 'normal') {
            const dist = parseFloat(document.getElementById('distance').value);
            if (dist > 0 && fov > 0) {
                viewW = 2 * dist * Math.tan(rad / 2);
                gsdVal = (viewW * 1000) / pw;
                resultVal = gsdVal;
                
                resultLabelText = "GSD (地上画素寸法)";
                resultUnit = " mm/px";
                document.getElementById('resMain').innerText = resultVal.toFixed(2) + resultUnit;
            }
        } else {
            const targetGsd = parseFloat(document.getElementById('target_gsd').value);
            if (targetGsd > 0 && fov > 0) {
                resultVal = (targetGsd * pw) / (2000 * Math.tan(rad / 2));
                viewW = 2 * resultVal * Math.tan(rad / 2);
                gsdVal = targetGsd; // 比較用に保存

                resultLabelText = "必要な対地高度";
                resultUnit = " m";
                document.getElementById('resMain').innerText = resultVal.toFixed(1) + resultUnit;
            }
        }

        if(viewW > 0){
             const viewH = viewW * (sh / sw);
             document.getElementById('resLabel').innerText = resultLabelText;
             document.getElementById('resSub').innerText = `撮影範囲: ${viewW.toFixed(2)} m x ${viewH.toFixed(2)} m`;
             document.getElementById('resultArea').style.display = 'block';

             // --- 2. モーションブラー計算 (Optional) ---
             const speed = parseFloat(document.getElementById('speed').value);
             const shutterDenom = parseFloat(document.getElementById('shutter').value);
             const blurBox = document.getElementById('blurResult');

             if (speed > 0 && shutterDenom > 0) {
                 // シャッタースピード秒数 (1/1000 -> 0.001)
                 const shutterSec = 1 / shutterDenom;
                 // 移動量 (m) = m/s * s
                 const moveM = speed * shutterSec;
                 // 移動量 (mm)
                 const moveMm = moveM * 1000;

                 let msg = `移動ブレ: ${moveMm.toFixed(2)} mm (GSDの ${(moveMm/gsdVal).toFixed(1)}倍)`;
                 
                 // 判定: ブレがGSDを超えたら警告 (赤), GSD以下ならOK (緑)
                 if (moveMm > gsdVal) {
                     blurBox.className = "blur-res blur-ng";
                     blurBox.innerText = "⚠️ " + msg + "\nブレが解像度を超えています。速度を落とすかシャッターを速くしてください。";
                 } else {
                     blurBox.className = "blur-res blur-ok";
                     blurBox.innerText = "✅ " + msg + "\n適正な設定です (ブレ < GSD)";
                 }
                 blurBox.style.display = 'block';
             } else {
                 // 入力がない場合は隠す
                 blurBox.style.display = 'none';
             }
        }
    }
</script>
</body>
</html>